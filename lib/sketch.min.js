(function(){var e=[].slice;(function(t){var n;t.fn.sketch=function(){var r,i,s;i=arguments[0],r=2<=arguments.length?e.call(arguments,1):[];if(this.length>1){t.error("Sketch.js can only be called on one element at a time.")}s=this.data("sketch");if(typeof i==="string"&&s){if(s[i]){if(typeof s[i]==="function"){return s[i].apply(s,r)}else if(r.length===0){return s[i]}else if(r.length===1){return s[i]=r[0]}}else{return t.error("Sketch.js did not recognize the given command.")}}else if(s){return s}else{this.data("sketch",new n(this.get(0),i));return this}};n=function(){function e(e,n){this.el=e;this.canvas=t(e);this.context=e.getContext("2d");this.options=t.extend({toolLinks:true,defaultTool:"marker",defaultColor:"#000000",defaultSize:5},n);this.painting=false;this.color=this.options.defaultColor;this.size=this.options.defaultSize;this.tool=this.options.defaultTool;this.actions=[];this.action=[];this.canvas.bind("click mousedown mouseup mousemove mouseleave mouseout touchstart touchmove touchend touchcancel",this.onEvent);if(this.options.toolLinks){t("body").delegate('a[href="#'+this.canvas.attr("id")+'"]',"click",function(e){var n,r,i,s,o,u,a;r=t(this);n=t(r.attr("href"));s=n.data("sketch");a=["color","size","tool"];for(o=0,u=a.length;o<u;o++){i=a[o];if(r.attr("data-"+i)){s.set(i,t(this).attr("data-"+i))}}if(t(this).attr("data-download")){s.download(t(this).attr("data-download"))}return false})}}e.prototype.download=function(e){var t;e||(e="png");if(e==="jpg"){e="jpeg"}t="image/"+e;return window.open(this.el.toDataURL(t))};e.prototype.set=function(e,t){this[e]=t;return this.canvas.trigger("sketch.change"+e,t)};e.prototype.startPainting=function(){this.painting=true;return this.action={tool:this.tool,color:this.color,size:parseFloat(this.size),events:[]}};e.prototype.stopPainting=function(){if(this.action){this.actions.push(this.action)}this.painting=false;this.action=null;return this.redraw()};e.prototype.onEvent=function(e){if(e.originalEvent&&e.originalEvent.targetTouches){e.pageX=e.originalEvent.targetTouches[0].pageX;e.pageY=e.originalEvent.targetTouches[0].pageY}t.sketch.tools[t(this).data("sketch").tool].onEvent.call(t(this).data("sketch"),e);e.preventDefault();return false};e.prototype.redraw=function(){var e;this.el.width=this.canvas.width();this.context=this.el.getContext("2d");e=this;t.each(this.actions,function(){if(this.tool){return t.sketch.tools[this.tool].draw.call(e,this)}});if(this.painting&&this.action){return t.sketch.tools[this.action.tool].draw.call(e,this.action)}};return e}();t.sketch={tools:{}};t.sketch.tools.marker={onEvent:function(e){switch(e.type){case"mousedown":case"touchstart":if(this.painting){this.stopPainting()}this.startPainting();break;case"mouseup":case"mouseout":case"mouseleave":case"touchend":case"touchcancel":this.stopPainting()}if(this.painting){this.action.events.push({x:e.pageX-this.canvas.offset().left,y:e.pageY-this.canvas.offset().top,event:e.type});return this.redraw()}},draw:function(e){var t,n,r,i,s;this.context.lineJoin="round";this.context.lineCap="round";this.context.beginPath();this.context.moveTo(e.events[0].x,e.events[0].y);s=e.events;for(r=0,i=s.length;r<i;r++){t=s[r];this.context.lineTo(t.x,t.y);n=t}this.context.strokeStyle=e.color;this.context.lineWidth=e.size;return this.context.stroke()}};return t.sketch.tools.eraser={onEvent:function(e){return t.sketch.tools.marker.onEvent.call(this,e)},draw:function(e){var n;n=this.context.globalCompositeOperation;this.context.globalCompositeOperation="destination-out";e.color="rgba(0,0,0,1)";t.sketch.tools.marker.draw.call(this,e);return this.context.globalCompositeOperation=n}}})(jQuery)}).call(this)
